---
# Tasks to install Dataiku DSS and configure a systemd service
- name: Ensure package cache is up to date (Debian)
  apt:
    update_cache: yes
  when: ansible_os_family == 'Debian'

- name: Install required packages (Debian)
  apt:
    name: "{{ pkg_list_debian }}"
    state: present
  when: ansible_os_family == 'Debian'

- name: Install required packages (RedHat)
  yum:
    name: "{{ pkg_list_redhat }}"
    state: present
  when: ansible_os_family == 'RedHat'

- name: Ensure dss user exists
  user:
    name: "{{ dss_user }}"
    createhome: yes

- name: Create install base directory
  file:
    path: "{{ install_base }}"
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Copy Dataiku archive from ansible server
  synchronize:
    src: "{{ local_archive_path }}"
    dest: "{{ tmp_archive }}"
    mode: push
  register: copied

- name: Extract Dataiku archive to install base
  unarchive:
    src: "{{ tmp_archive }}"
    dest: "{{ install_base }}"
    remote_src: yes

- name: Set install_dir variable if not provided
  set_fact:
    install_dir: "{{ install_dir }}"

- name: Run install-deps.sh (root)
  command: "{{ install_dir }}/scripts/install/install-deps.sh -yes"
  args:
    chdir: "{{ install_dir }}"
  become: true
  become_user: root

- name: Create data directory for this node
  file:
    path: "{{ data_dir }}"
    state: directory
    owner: "{{ dss_user }}"
    group: "{{ dss_user }}"
    mode: '0755'

- name: Run installer.sh as dss user
  command: "{{ install_dir }}/installer.sh -d {{ data_dir }} -p {{ dss_port }} -t {{ node_type }}"
  args:
    chdir: "{{ install_dir }}"
  become: true
  become_user: "{{ dss_user }}"

- name: Run install-boot.sh to create boot/service (root)
  command: "{{ install_dir }}/scripts/install/install-boot.sh -n {{ boot_name }} {{ data_dir }} {{ dss_user }}"
  args:
    chdir: "{{ install_dir }}"
  become: true
  become_user: root

- name: Deploy systemd service file
  template:
    src: dataiku.service.j2
    dest: "/etc/systemd/system/{{ service_name }}.service"
    owner: root
    group: root
    mode: '0644'
  notify: Reload systemd


- name: Reload systemd
  command: systemctl daemon-reload
  become: true
  become_user: root

- name: Enable and start Dataiku service
  systemd:
    name: "{{ service_name }}"
    state: started
    enabled: yes
    daemon_reload: yes
