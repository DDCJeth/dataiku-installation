---
# Tasks to install Dataiku DSS and configure a systemd service
- name: Install required packages according to OS
  package:
    name: "{{ pkg_list[ansible_os_family] }}"
    state: present
  vars:
    pkg_list:
      Debian: "{{ pkg_list_debian }}"
      RedHat: "{{ pkg_list_redhat }}"

- name: Install rsync
  dnf:
    name: rsync
    state: present
  become: true

- name: Ensure dss user exists
  user:
    name: "{{ dss_user }}"
    createhome: yes

- name: Create install base directory
  file:
    path: "{{ install_base }}"
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Copy Dataiku archive from ansible server
  synchronize:
    src: "{{ local_archive_path }}"
    dest: "{{ tmp_archive }}"
    mode: push
  register: copied

- name: Extract Dataiku archive to install base
  unarchive:
    src: "{{ tmp_archive }}"
    dest: "{{ install_base }}"
    remote_src: yes

- name: Set install_dir variable if not provided
  set_fact:
    install_dir: "{{ install_dir }}"

- name: Run install-deps.sh (root)
  command: "{{ install_dir }}/scripts/install/install-deps.sh -yes"
  args:
    chdir: "{{ install_dir }}"
  become: true
  become_user: root

- name: Create data directory for this node
  file:
    path: "{{ data_dir }}"
    state: directory
    owner: "{{ dss_user }}"
    group: "{{ dss_user }}"
    mode: '0755'

- name: Run installer.sh as dss user
  command: "{{ install_dir }}/installer.sh -d {{ data_dir }} -p {{ dss_port }} -t {{ node_type }}"
  args:
    chdir: "{{ install_dir }}"
  become: true
  become_user: "{{ dss_user }}"

- name: Deploy systemd service file
  command: "{{ install_dir }}/scripts/install/install-boot.sh -n {{ boot_name }} {{ data_dir }} {{ dss_user }}"
  args:
    chdir: "{{ install_dir }}"
  become: true
  become_user: root

- name: Reload systemd
  command: systemctl daemon-reload
  become: true
  become_user: root

- name: Enable and start Dataiku service
  systemd:
    name: "{{ service_name }}"
    state: started
    enabled: yes
    daemon_reload: yes
